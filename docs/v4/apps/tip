{"captainVersion":4,"services":{"$$cap_appname-mongodb":{"image":"mongo:6.0","restart":"always","environment":{"MONGO_INITDB_DATABASE":"tip","TZ":"$$cap_timezone"},"volumes":["$$cap_appname-mongodb-data:/data/db","$$cap_appname-mongodb-config:/data/configdb"],"caproverExtra":{"notExposeAsWebApp":"true"}},"$$cap_appname-redis":{"image":"redis:7-alpine","restart":"always","command":"redis-server --appendonly yes","volumes":["$$cap_appname-redis-data:/data"],"caproverExtra":{"notExposeAsWebApp":"true"}},"$$cap_appname-backend":{"restart":"always","environment":{"TZ":"$$cap_timezone","APP_ENV":"$$cap_app_env","APP_DEBUG":"$$cap_app_debug","APP_KEY":"$$cap_app_key","APP_URL":"https://$$cap_appname.$$cap_root_domain","DB_CONNECTION":"mongodb","DB_HOST":"srv-captain--$$cap_appname-mongodb","DB_PORT":"27017","DB_DATABASE":"tip","MONGODB_URI":"mongodb://srv-captain--$$cap_appname-mongodb:27017/tip","CACHE_DRIVER":"redis","SESSION_DRIVER":"redis","QUEUE_CONNECTION":"redis","REDIS_HOST":"srv-captain--$$cap_appname-redis","REDIS_PORT":"6379"},"volumes":["$$cap_appname-backend-storage:/var/www/html/storage"],"depends_on":["$$cap_appname-mongodb","$$cap_appname-redis"],"caproverExtra":{"containerHttpPort":"80","notExposeAsWebApp":"true","dockerfileLines":["FROM php:8.2-fpm","ARG BACK_REPO_URL=$$cap_back_repo_url","ARG BACK_REPO_REF=$$cap_back_repo_ref","WORKDIR /var/www/html","RUN apt-get update && apt-get install -y git curl libpng-dev libonig-dev libxml2-dev libzip-dev libssl-dev zip unzip nginx supervisor && apt-get clean && rm -rf /var/lib/apt/lists/*","RUN docker-php-ext-install pdo pdo_mysql mbstring exif pcntl bcmath gd zip","RUN pecl install mongodb redis && docker-php-ext-enable mongodb redis","COPY --from=composer:latest /usr/bin/composer /usr/bin/composer","RUN git clone --depth 1 --branch ${BACK_REPO_REF} https://$$cap_repo_username:$$cap_repo_pat@github.com/PKKSA/ClientTIPBack.git /var/www/html","RUN composer install --no-dev --optimize-autoloader --no-interaction","RUN mkdir -p storage/framework/{cache,sessions,views} storage/logs bootstrap/cache","RUN cp .env.example .env 2>/dev/null || true","RUN chown -R www-data:www-data /var/www/html && chmod -R 755 /var/www/html/storage && chmod -R 755 /var/www/html/bootstrap/cache","RUN echo 'server { \\n    listen 80; \\n    server_name _; \\n    root /var/www/html/public; \\n    index index.php; \\n    client_max_body_size 100M; \\n    location / { \\n        try_files $uri $uri/ /index.php?$query_string; \\n    } \\n    location ~ \\.php$ { \\n        fastcgi_pass 127.0.0.1:9000; \\n        fastcgi_index index.php; \\n        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name; \\n        include fastcgi_params; \\n        fastcgi_read_timeout 300; \\n    } \\n    location ~ /\\.(?!well-known).* { \\n        deny all; \\n    } \\n}' > /etc/nginx/sites-available/default","RUN echo '[supervisord]\\nnodaemon=true\\n\\n[program:nginx]\\ncommand=/usr/sbin/nginx -g \"daemon off;\"\\nautostart=true\\nautorestart=true\\n\\n[program:php-fpm]\\ncommand=/usr/local/sbin/php-fpm -F\\nautostart=true\\nautorestart=true\\n\\n[program:laravel-scheduler]\\ncommand=/bin/sh -c \"while [ true ]; do php /var/www/html/artisan schedule:run --verbose --no-interaction & sleep 60; done\"\\nautostart=true\\nautorestart=true' > /etc/supervisor/conf.d/supervisord.conf","EXPOSE 80","CMD [\"/usr/bin/supervisord\", \"-c\", \"/etc/supervisor/conf.d/supervisord.conf\"]"]}},"$$cap_appname-frontend":{"restart":"always","environment":{"NODE_ENV":"production"},"depends_on":["$$cap_appname-backend"],"caproverExtra":{"containerHttpPort":"80","notExposeAsWebApp":"true","dockerfileLines":["FROM node:18-alpine AS build","ARG FRONT_REPO_REF=$$cap_front_repo_ref","ARG VITE_API_URL","WORKDIR /app","RUN apk add --no-cache git","RUN git clone --depth 1 --branch ${FRONT_REPO_REF} https://$$cap_repo_username:$$cap_repo_pat@github.com/PKKSA/ClientTIPFront.git /app","RUN npm ci --legacy-peer-deps","ENV VITE_API_URL=$VITE_API_URL","RUN npm run build","FROM nginx:alpine","COPY --from=build /app/dist /usr/share/nginx/html","RUN echo 'server { \\n    listen 80; \\n    server_name _; \\n    root /usr/share/nginx/html; \\n    index index.html; \\n    gzip on; \\n    gzip_vary on; \\n    gzip_min_length 1024; \\n    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml; \\n    location / { \\n        try_files $uri $uri/ /index.html; \\n    } \\n    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ { \\n        expires 1y; \\n        add_header Cache-Control \"public, immutable\"; \\n    } \\n}' > /etc/nginx/conf.d/default.conf","EXPOSE 80","CMD [\"nginx\", \"-g\", \"daemon off;\"]"]}},"$$cap_appname-gateway":{"restart":"always","depends_on":["$$cap_appname-backend","$$cap_appname-frontend"],"caproverExtra":{"containerHttpPort":"80","dockerfileLines":["FROM nginx:alpine","RUN echo 'upstream backend { \\n    server srv-captain--$$cap_appname-backend:80; \\n} \\n\\nupstream frontend { \\n    server srv-captain--$$cap_appname-frontend:80; \\n} \\n\\nserver { \\n    listen 80; \\n    server_name _; \\n    client_max_body_size 100M; \\n\\n    location /api { \\n        proxy_pass http://backend; \\n        proxy_http_version 1.1; \\n        proxy_set_header Upgrade $http_upgrade; \\n        proxy_set_header Connection \"upgrade\"; \\n        proxy_set_header Host $host; \\n        proxy_set_header X-Real-IP $remote_addr; \\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; \\n        proxy_set_header X-Forwarded-Proto $scheme; \\n        proxy_read_timeout 300; \\n    } \\n\\n    location / { \\n        proxy_pass http://frontend; \\n        proxy_http_version 1.1; \\n        proxy_set_header Upgrade $http_upgrade; \\n        proxy_set_header Connection \"upgrade\"; \\n        proxy_set_header Host $host; \\n        proxy_set_header X-Real-IP $remote_addr; \\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; \\n        proxy_set_header X-Forwarded-Proto $scheme; \\n    } \\n}' > /etc/nginx/conf.d/default.conf","EXPOSE 80","CMD [\"nginx\", \"-g\", \"daemon off;\"]"]}}},"caproverOneClickApp":{"variables":[{"id":"$$cap_repo_username","label":"GitHub username","description":"GitHub username for accessing private repos.","defaultValue":"manwar-dev"},{"id":"$$cap_repo_pat","label":"GitHub personal access token","description":"GitHub PAT with repo read access."},{"id":"$$cap_back_repo_ref","label":"Backend Git branch/tag","description":"Branch or tag for ClientTIPBack repo.","defaultValue":"master"},{"id":"$$cap_front_repo_ref","label":"Frontend Git branch/tag","description":"Branch or tag for ClientTIPFront repo.","defaultValue":"master"},{"id":"$$cap_app_env","label":"Laravel APP_ENV","defaultValue":"production"},{"id":"$$cap_app_debug","label":"Laravel APP_DEBUG","defaultValue":"false"},{"id":"$$cap_app_key","label":"Laravel APP_KEY","description":"Generate with: php artisan key:generate --show","defaultValue":"base64:your-key-here"},{"id":"$$cap_timezone","label":"Container timezone","defaultValue":"Etc/UTC"}],"instructions":{"start":"This deploys the TIP (Threat Intelligence Platform) stack:\\n- MongoDB 6.0\\n- Redis 7\\n- Laravel Backend (ClientTIPBack)\\n- Vue.js Frontend (ClientTIPFront)\\n- Nginx Gateway\\n\\nYou need GitHub credentials with access to PKKSA/ClientTIPBack and PKKSA/ClientTIPFront repos.","end":"Deployment started! After all services show green, set $$cap_appname.$$cap_root_domain as the domain for $$cap_appname-gateway and enable HTTPS."},"displayName":"TIP Platform (Threat Intelligence)","isOfficial":false,"description":"Deploys MongoDB, Redis, Laravel backend, and Vue frontend for the Threat Intelligence Platform.","documentation":"https://github.com/PKKSA/ClientTIPBack"}}
