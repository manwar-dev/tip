{
  "captainVersion": 4,
  "services": {
    "$$cap_appname-mongodb": {
      "image": "mongo:6.0",
      "restart": "always",
      "environment": {
        "MONGO_INITDB_DATABASE": "grc",
        "TZ": "$$cap_timezone"
      },
      "volumes": [
        "$$cap_appname-mongodb-data:/data/db",
        "$$cap_appname-mongodb-config:/data/configdb"
      ],
      "caproverExtra": {
        "notExposeAsWebApp": "true"
      }
    },
    "$$cap_appname-redis": {
      "image": "redis:7-alpine",
      "restart": "always",
      "command": "redis-server --appendonly yes",
      "volumes": [
        "$$cap_appname-redis-data:/data"
      ],
      "caproverExtra": {
        "notExposeAsWebApp": "true"
      }
    },
    "$$cap_appname-backend": {
      "restart": "always",
      "environment": {
        "TZ": "$$cap_timezone",
        "APP_ENV": "$$cap_app_env",
        "APP_DEBUG": "$$cap_app_debug",
        "APP_KEY": "$$cap_app_key",
        "APP_URL": "https://$$cap_appname.$$cap_root_domain",
        "DB_CONNECTION": "mongodb",
        "DB_HOST": "srv-captain--$$cap_appname-mongodb",
        "DB_PORT": "27017",
        "DB_DATABASE": "grc",
        "CACHE_DRIVER": "redis",
        "SESSION_DRIVER": "redis",
        "QUEUE_CONNECTION": "redis",
        "REDIS_HOST": "srv-captain--$$cap_appname-redis",
        "REDIS_PORT": "6379",
        "OBSTRACTS_URL": "$$cap_obstracts_url",
        "OBSTRACTS_API_URL": "$$cap_obstracts_api_url",
        "TIP_API_URL": "$$cap_tip_api_url"
      },
      "volumes": [
        "$$cap_appname-backend-storage:/var/www/html/storage"
      ],
      "depends_on": [
        "$$cap_appname-mongodb",
        "$$cap_appname-redis"
      ],
      "caproverExtra": {
        "containerHttpPort": "80",
        "notExposeAsWebApp": "true",
        "dockerfileLines": [
          "FROM php:8.2-fpm",
          "ARG BACK_REPO_REF=$$cap_back_repo_ref",
          "RUN apt-get update && apt-get install -y git curl libpng-dev libonig-dev libxml2-dev libzip-dev libssl-dev zip unzip nginx supervisor && apt-get clean && rm -rf /var/lib/apt/lists/*",
          "RUN docker-php-ext-install pdo pdo_mysql mbstring exif pcntl bcmath gd zip",
          "RUN pecl install mongodb redis && docker-php-ext-enable mongodb redis",
          "COPY --from=composer:latest /usr/bin/composer /usr/bin/composer",
          "RUN git clone --depth 1 --branch ${BACK_REPO_REF} https://$$cap_repo_username:$$cap_repo_pat@github.com/PKKSA/ClientTIPBack.git /var/www/html",
          "WORKDIR /var/www/html",
          "RUN composer install --no-dev --optimize-autoloader --no-interaction",
          "RUN mkdir -p storage/framework/{cache,sessions,views} storage/logs bootstrap/cache",
          "RUN cp .env.example .env 2>/dev/null || true",
          "RUN chown -R www-data:www-data /var/www/html && chmod -R 755 /var/www/html/storage && chmod -R 755 /var/www/html/bootstrap/cache",
          "RUN printf '%s\\n' 'server {' '    listen 80;' '    server_name _;' '    root /var/www/html/public;' '    index index.php;' '    client_max_body_size 100M;' '    location / {' '        try_files $uri $uri/ /index.php?$query_string;' '    }' '    location ~ \\.php$ {' '        fastcgi_pass 127.0.0.1:9000;' '        fastcgi_index index.php;' '        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;' '        include fastcgi_params;' '        fastcgi_read_timeout 300;' '    }' '    location ~ /\\.(?!well-known).* {' '        deny all;' '    }' '}' > /etc/nginx/sites-available/default",
          "RUN printf '%s\\n' '[supervisord]' 'nodaemon=true' '' '[program:nginx]' 'command=/usr/sbin/nginx -g \"daemon off;\"' 'autostart=true' 'autorestart=true' '' '[program:php-fpm]' 'command=/usr/local/sbin/php-fpm -F' 'autostart=true' 'autorestart=true' '' '[program:laravel-scheduler]' 'command=/bin/sh -c \"while [ true ]; do php /var/www/html/artisan schedule:run --verbose --no-interaction & sleep 60; done\"' 'autostart=true' 'autorestart=true' > /etc/supervisor/conf.d/supervisord.conf",
          "RUN printf '%s\\n' '#!/bin/bash' 'chown -R www-data:www-data /var/www/html/storage' 'chmod -R 775 /var/www/html/storage' 'php artisan config:clear' 'php artisan cache:clear' 'exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf' > /start.sh && chmod +x /start.sh",
          "EXPOSE 80",
          "HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 CMD curl -f http://127.0.0.1/ || exit 0",
          "CMD [\"/start.sh\"]"
        ]
      }
    },
    "$$cap_appname-userservice": {
      "restart": "always",
      "environment": {
        "TZ": "$$cap_timezone",
        "APP_ENV": "$$cap_app_env",
        "APP_DEBUG": "$$cap_app_debug",
        "APP_KEY": "$$cap_userservice_app_key",
        "DB_CONNECTION": "mongodb",
        "DB_HOST": "srv-captain--$$cap_appname-mongodb",
        "DB_PORT": "27017",
        "DB_DATABASE": "GRC_USER_SERVICE",
        "REDIS_HOST": "srv-captain--$$cap_appname-redis",
        "REDIS_PORT": "6379"
      },
      "volumes": [
        "$$cap_appname-userservice-storage:/var/www/html/storage"
      ],
      "depends_on": [
        "$$cap_appname-mongodb",
        "$$cap_appname-redis"
      ],
      "caproverExtra": {
        "containerHttpPort": "80",
        "notExposeAsWebApp": "true",
        "dockerfileLines": [
          "FROM php:8.2-fpm",
          "ARG USERSERVICE_REPO_REF=$$cap_userservice_repo_ref",
          "RUN apt-get update && apt-get install -y git curl libpng-dev libonig-dev libxml2-dev libzip-dev libssl-dev zip unzip nginx supervisor libldap2-dev libldb-dev && apt-get clean && rm -rf /var/lib/apt/lists/*",
          "RUN docker-php-ext-configure ldap --with-libdir=lib/x86_64-linux-gnu/",
          "RUN docker-php-ext-install pdo pdo_mysql mbstring exif pcntl bcmath gd zip ldap",
          "RUN pecl install mongodb redis && docker-php-ext-enable mongodb redis",
          "COPY --from=composer:latest /usr/bin/composer /usr/bin/composer",
          "RUN git clone --depth 1 --branch ${USERSERVICE_REPO_REF} https://$$cap_repo_username:$$cap_repo_pat@github.com/PKKSA/User-Service-BackEnd.git /var/www/html",
          "WORKDIR /var/www/html",
          "RUN composer install --no-dev --optimize-autoloader --no-interaction",
          "RUN mkdir -p storage/framework/{cache,sessions,views} storage/logs bootstrap/cache",
          "RUN cp .env.example .env 2>/dev/null || true",
          "RUN chown -R www-data:www-data /var/www/html && chmod -R 755 /var/www/html/storage && chmod -R 755 /var/www/html/bootstrap/cache",
          "RUN printf '%s\\n' 'server {' '    listen 80;' '    server_name _;' '    root /var/www/html/public;' '    index index.php;' '    client_max_body_size 100M;' '    location / {' '        try_files $uri $uri/ /index.php?$query_string;' '    }' '    location ~ \\.php$ {' '        fastcgi_pass 127.0.0.1:9000;' '        fastcgi_index index.php;' '        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;' '        include fastcgi_params;' '        fastcgi_read_timeout 300;' '    }' '    location ~ /\\.(?!well-known).* {' '        deny all;' '    }' '}' > /etc/nginx/sites-available/default",
          "RUN printf '%s\\n' '[supervisord]' 'nodaemon=true' '' '[program:nginx]' 'command=/usr/sbin/nginx -g \"daemon off;\"' 'autostart=true' 'autorestart=true' '' '[program:php-fpm]' 'command=/usr/local/sbin/php-fpm -F' 'autostart=true' 'autorestart=true' > /etc/supervisor/conf.d/supervisord.conf",
          "RUN printf '%s\\n' '#!/bin/bash' 'chown -R www-data:www-data /var/www/html/storage' 'chmod -R 775 /var/www/html/storage' 'php artisan config:clear' 'php artisan cache:clear' 'exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf' > /start.sh && chmod +x /start.sh",
          "EXPOSE 80",
          "HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 CMD curl -f http://127.0.0.1/ || exit 0",
          "CMD [\"/start.sh\"]"
        ]
      }
    },
    "$$cap_appname-frontend": {
      "restart": "always",
      "environment": {
        "NODE_ENV": "production"
      },
      "depends_on": [
        "$$cap_appname-backend"
      ],
      "caproverExtra": {
        "containerHttpPort": "80",
        "notExposeAsWebApp": "true",
        "dockerfileLines": [
          "FROM node:18-alpine AS build",
          "ARG FRONT_REPO_REF=$$cap_front_repo_ref",
          "RUN apk add --no-cache git",
          "RUN git clone --depth 1 --branch ${FRONT_REPO_REF} https://$$cap_repo_username:$$cap_repo_pat@github.com/PKKSA/ClientTIPFront.git /app",
          "WORKDIR /app",
          "RUN npm ci --legacy-peer-deps",
          "RUN npm run build",
          "FROM nginx:alpine",
          "COPY --from=build /app/dist /usr/share/nginx/html",
          "RUN printf '%s\\n' 'server {' '    listen 80;' '    server_name _;' '    root /usr/share/nginx/html;' '    index index.html;' '    gzip on;' '    gzip_vary on;' '    gzip_min_length 1024;' '    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml;' '    location / {' '        try_files $uri $uri/ /index.html;' '    }' '    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {' '        expires 1y;' '        add_header Cache-Control \"public, immutable\";' '    }' '}' > /etc/nginx/conf.d/default.conf",
          "EXPOSE 80",
          "HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 CMD wget --no-verbose --tries=1 --spider http://127.0.0.1/ || exit 0",
          "CMD [\"nginx\", \"-g\", \"daemon off;\"]"
        ]
      }
    },
    "$$cap_appname-gateway": {
      "restart": "always",
      "depends_on": [
        "$$cap_appname-backend",
        "$$cap_appname-frontend",
        "$$cap_appname-userservice"
      ],
      "caproverExtra": {
        "containerHttpPort": "80",
        "dockerfileLines": [
          "FROM nginx:alpine",
          "RUN printf '%s\\n' 'resolver 127.0.0.11 valid=10s ipv6=off;' '' 'server {' '    listen 80;' '    server_name _;' '    client_max_body_size 100M;' '' '    set $backend \"srv-captain--$$cap_appname-backend\";' '    set $frontend \"srv-captain--$$cap_appname-frontend\";' '    set $userservice \"srv-captain--$$cap_appname-userservice\";' '' '    location /api {' '        proxy_pass http://$backend:80;' '        proxy_http_version 1.1;' '        proxy_set_header Host $host;' '        proxy_set_header X-Real-IP $remote_addr;' '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' '        proxy_set_header X-Forwarded-Proto $scheme;' '        proxy_connect_timeout 300;' '        proxy_send_timeout 300;' '        proxy_read_timeout 300;' '    }' '' '    location /user-api {' '        rewrite ^/user-api/(.*)$ /api/$1 break;' '        proxy_pass http://$userservice:80;' '        proxy_http_version 1.1;' '        proxy_set_header Host $host;' '        proxy_set_header X-Real-IP $remote_addr;' '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' '        proxy_set_header X-Forwarded-Proto $scheme;' '        proxy_connect_timeout 300;' '        proxy_send_timeout 300;' '        proxy_read_timeout 300;' '    }' '' '    location / {' '        proxy_pass http://$frontend:80;' '        proxy_http_version 1.1;' '        proxy_set_header Host $host;' '        proxy_set_header X-Real-IP $remote_addr;' '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' '        proxy_set_header X-Forwarded-Proto $scheme;' '        proxy_set_header Upgrade $http_upgrade;' '        proxy_set_header Connection \"upgrade\";' '    }' '}' > /etc/nginx/conf.d/default.conf",
          "EXPOSE 80",
          "HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 CMD wget --no-verbose --tries=1 --spider http://127.0.0.1/ || exit 0",
          "CMD [\"nginx\", \"-g\", \"daemon off;\"]"
        ]
      }
    }
  },
  "caproverOneClickApp": {
    "variables": [
      {
        "id": "$$cap_repo_username",
        "label": "GitHub username",
        "description": "GitHub username for accessing private repos.",
        "defaultValue": "manwar-dev"
      },
      {
        "id": "$$cap_repo_pat",
        "label": "GitHub personal access token",
        "description": "GitHub PAT with repo read access."
      },
      {
        "id": "$$cap_back_repo_ref",
        "label": "Backend Git branch/tag",
        "description": "Branch or tag for ClientTIPBack repo.",
        "defaultValue": "tip"
      },
      {
        "id": "$$cap_front_repo_ref",
        "label": "Frontend Git branch/tag",
        "description": "Branch or tag for ClientTIPFront repo.",
        "defaultValue": "tip"
      },
      {
        "id": "$$cap_userservice_repo_ref",
        "label": "User Service Git branch/tag",
        "description": "Branch or tag for User-Service-BackEnd repo.",
        "defaultValue": "tip"
      },
      {
        "id": "$$cap_app_env",
        "label": "Laravel APP_ENV",
        "defaultValue": "production"
      },
      {
        "id": "$$cap_app_debug",
        "label": "Laravel APP_DEBUG",
        "defaultValue": "false"
      },
      {
        "id": "$$cap_app_key",
        "label": "Backend APP_KEY",
        "description": "Generate with: php artisan key:generate --show",
        "defaultValue": "base64:Df21IZc7ZOjMu/OAkff8pS8yV+u4w7VYzGbtXzC92ig="
      },
      {
        "id": "$$cap_userservice_app_key",
        "label": "User Service APP_KEY",
        "description": "Generate with: php artisan key:generate --show",
        "defaultValue": "base64:Df21IZc7ZOjMu/OAkff8pS8yV+u4w7VYzGbtXzC92ig="
      },
      {
        "id": "$$cap_obstracts_url",
        "label": "Obstracts API URL",
        "description": "URL for Obstracts TIP service API",
        "defaultValue": "http://72.60.131.10:8001/api/v1"
      },
      {
        "id": "$$cap_obstracts_api_url",
        "label": "Obstracts Base URL",
        "description": "Base URL for Obstracts service",
        "defaultValue": "http://72.60.131.10:8001"
      },
      {
        "id": "$$cap_tip_api_url",
        "label": "TIP API URL",
        "description": "URL for TIP service",
        "defaultValue": "http://72.60.131.10:8001"
      },
      {
        "id": "$$cap_timezone",
        "label": "Container timezone",
        "defaultValue": "Etc/UTC"
      }
    ],
    "instructions": {
      "start": "This deploys the TIP (Threat Intelligence Platform) stack:\n- MongoDB 6.0\n- Redis 7\n- Laravel Backend (ClientTIPBack)\n- Laravel User Service (User-Service-BackEnd)\n- Vue.js Frontend (ClientTIPFront)\n- Nginx Gateway\n\nYou need GitHub credentials with access to PKKSA repos.",
      "end": "Deployment started! After all services show green:\n1. Set $$cap_appname-gateway.$$cap_root_domain as the domain\n2. Enable HTTPS\n3. Access your TIP at https://$$cap_appname-gateway.$$cap_root_domain"
    },
    "displayName": "TIP Platform (Threat Intelligence)",
    "isOfficial": false,
    "description": "Deploys MongoDB, Redis, Laravel backend, User Service, and Vue frontend for the Threat Intelligence Platform.",
    "documentation": "https://github.com/manwar-dev/tip"
  }
}
